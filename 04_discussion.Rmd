# Figures and Tables

(ref:Table1Caption) Count of random set locations selected from the set of 2x2km grid cells, within the five spatial strata (S~1~-S~5~) 
                    and three depth strata (RD~1~-RD~3~) for all years the random survey component has been conducted.  The five spatial 
                    strata can be seen in Figure 1, and the depth strata include RD~1~ (100-250 fathoms), RD~2~ (250-450 fathoms) and RD~3~ (450-750 fathoms).

```{r table1, echo=FALSE}
  
    options(knitr.kable.NA = '')       # change the NA to blank
    dtBW        <- paste("select * from Report_CountRandomSet where Year <= ", yr+1,
                       " union select 2010,'Z',NULL,NULL,NULL,NULL ",
                        "union select 2010,'Z2',NULL,NULL,NULL,NULL ",
                        "union select 2010,'Z3',NULL,NULL,NULL,NULL ",
                        "union select 2010,'Z4',NULL,NULL,NULL,NULL ",
                        "union select 2010,'Z5',NULL,NULL,NULL,NULL ",
                        "union select 2010,'Z6',NULL,NULL,NULL,NULL ",
                        "from Report_CountRandomSet", sep="")
    dat        <- GetSQLData(dtBW,"Sablefish")
   
   dat2       <- dat[dat$Year>=2011,]
   dat1       <- dat[dat$Year<=2010,] 
   cleandata2 <- dat2 
   cleandata1 <- dat1
   cleandata1[49,2] <- ' '
   cleandata1[50,2] <- ' '
   cleandata1[51,2] <- ' '
   cleandata1[52,2] <- ' '
   cleandata1[53,2] <- ' '
   cleandata1[54,2] <- ' '
   cleandata2$Year <- cleanf(cleandata2$Year) 
   cleandata1$Year <- cleanf(cleandata1$Year)  #-- remove duplicates function
   colnames(cleandata2) <- c( "Year", "Strata", "RD1","RD2","RD3","Total")
   colnames(cleandata1) <- c( "Year", "Strata", "RD1","RD2","RD3","Total")
   
   new <- cbind(cleandata1, cleandata2)
   library(kableExtra)

     kableExtra::kable(new,
                     booktabs = TRUE,linesep = "",
                     format = "latex",  caption = "(ref:Table1Caption)") %>%
     kableExtra::kable_styling(font_size = 8) %>%
     row_spec(5,  hline_after = T) %>%
     row_spec(6,  bold = T,  hline_after = T)%>%
     row_spec(11, hline_after = T)%>%
     row_spec(12, bold = T,  hline_after = T)%>%
     row_spec(17, hline_after = T)%>%
     row_spec(18, bold = T,  hline_after = T)%>%
     row_spec(23, hline_after = T)%>%
     row_spec(24, bold = T,  hline_after = T)%>%
     row_spec(29, hline_after = T)%>%
     row_spec(30, bold = T,  hline_after = T)%>% 
     row_spec(35, hline_after = T)%>%
     row_spec(36, bold = T,  hline_after = T)%>%
     row_spec(41, hline_after = T)%>%
     row_spec(42, bold = T,  hline_after = T)%>%
     row_spec(47, hline_after = T)%>%
     row_spec(48, bold = T,  hline_after = T)%>%
     row_spec(53, hline_after = T)
```

(ref:Table2Caption) British Columbia Sablefish research and assessment surveys, 1988 to `r yr+1`.

```{r table2, echo=FALSE}
   dtBW   <- paste("exec dbo.procRKnitr_SurveyTrips ",yr+1,sep="")
   trip   <- GetSQLData(dtBW,"Sablefish")
   
  kableExtra::kable(trip,
                    booktabs = TRUE,linesep = "",
                    format = "latex",  caption = "(ref:Table2Caption)") %>%
                    kableExtra::kable_styling(font_size = 8)
```

(ref:Table3Caption) Components of the `r yr` and `r yr+1` Sablefish research and assessment surveys.

```{r table3, echo=FALSE,font_size = 8}
   # --  Create a dataframe 4 columns wide, 2019 and beyond, no benthic impact study
   Component    <- c("Stratified random sampling,",
                     "(StRS)",
                     "Type 3 (Random tagging)","",
                     "Traditional Inlet","Standardized","","" )
                 # , "Benthic impact","","","","") 
   Bait         <- c("2 lbs frozen squid", "(bagged)", 
                     "10 lbs Hake (loose)","",
                     "2 lbs frozen squid", 
                     "(bagged)","", "" )
                 # , "Nuytco autonomous","camera system and","HOBO Pendant G","Loggers attached to","select traps") 
   Locations    <- c("Five spatial strata", 
                     "(S1-S5)", "","",
                     "Dean/Burke Channel", 
                     "Finlayson Channel", 
                     "Gil Island", 
                     "Portland Inlet" )
                 # , "Five spatial strata","(S1-S5)","","","")
   Protocol     <- c("1/3 of traps used for tagging (<125 pieces),",
                     "1/3 of traps used for biosamples,",
                     "(50 piece LSWMO)",
                     "1/3 of traps discarded",
                     "1/2 of traps used for tagging,",
                     "1/2 of traps used for biosample","(50 piece LSWMO)"," " )
                 # , "Camera system deployed on","survey sets.  Accelerometers","deployed on camera and survey", "sets.","")

   df           <- data.frame(Component, Bait, Locations, Protocol) 
   colnames(df) <- c("Component", "Bait", "Locations", "Sampling Protocol")
   sampleTable <- data.frame(C1 = c(rep("a", 5), rep("b", 5)),
                             C2 = 1:10   )
   
   kableExtra::kable(df[1:8, 1:4],
                    booktabs = TRUE,linesep = "",
                    format = "latex",  caption = "(ref:Table3Caption)") %>%
                    row_spec(4,  hline_after = T) %>%
                    kableExtra::kable_styling(font_size = 8)

``` 

(ref:Table4Caption) Summary of species captured during the `r yr` survey Type 3 tagging sets (StRS design) conducted by the `r boat`. 
                    No value in the weight column indicates that the catch was not weighed. No value in both weight and count indicates 
                    a trace weight recorded from a trap of less than 1 kg.

```{r table4,  echo=FALSE}
  options(knitr.kable.NA = '')
  dtSP   <- paste("exec procRReport_SpeciesSummary ",yr," ,'StRS'",sep="")
  datSP  <- GetSQLData(dtSP,"Sablefish")
  dat1SP <- datSP[,c(-1)] 
  dat1SP <- dat1SP[,c(-3)]
  dat1SP <- dat1SP[,c(-2)]
  dat1SP <- dat1SP[,c(-6)]
  cleandataSP<-dat1SP
  cleandataSP$Summary_sp <- cleanf(cleandataSP$Summary_sp)  #use the remove duplicates function
  colnames(cleandataSP)  <- c( "Category", "Common Name", "Scientific Name" , "Count", "Weight(kg)")
  
  kableExtra::kable(cleandataSP,
                    booktabs = TRUE,linesep = "",
                    format = "latex",  caption = "(ref:Table4Caption)") %>%
                    row_spec(10,  hline_after = T) %>%
                    row_spec(23,  hline_after = T) %>%
                    row_spec(26,  hline_after = T) %>%
                    kableExtra::kable_styling(font_size = 8)
```

(ref:Table5Caption) Summary of species captured by the `r boat` during the `r yr` survey standardized sets conducted at mainland inlet localities. 
                    Null values indicate the catch was not counted or weighed.  No value in both weight and count indicates a trace weight recorded from a trap of less than 1 kg.


```{r table5, echo=FALSE}
  options(knitr.kable.NA = '')
  dtSP   <- paste("exec procRReport_SpeciesSummary ",yr," ,'INLET STANDARDIZED'",sep="")
  datSP  <- GetSQLData(dtSP,"Sablefish")
  dat1SP <- datSP[,c(-1)] 
  dat1SP <- dat1SP[,c(-3)]
  dat1SP <- dat1SP[,c(-2)]
  dat1SP <- dat1SP[,c(-6)]
  cleandataSPi<-dat1SP
  cleandataSPi$Summary_sp <- cleanf(cleandataSPi$Summary_sp)  #use the remove duplicates function
  colnames(cleandataSPi)  <- c( "Category", "Common Name", "Scientific Name" , "Count", "Weight(kg)")

  kableExtra::kable(cleandataSPi,
                    booktabs = TRUE,linesep = "",
                    format = "latex",  caption = "(ref:Table5Caption)") %>%
                    row_spec(2,  hline_after = T) %>%
                    row_spec(6,  hline_after = T) %>%
                    row_spec(8,  hline_after = T) %>%
                    kableExtra::kable_styling(font_size = 8)

```
(ref:Table6Caption) Summary of species captured during the `r yr+1` survey Type 3 tagging sets (StRS design) conducted by the `r boat2`, 
                    No value in the weight column indicates that the catch was not weighed. No value in both weight and count indicates 
                    a trace weight recorded from a trap of less than 1 kg.
                   
```{r table6,  echo=FALSE}
  options(knitr.kable.NA = '')
  dtSP   <- paste("exec procRReport_SpeciesSummary ", yr+1," ,'StRS'",sep="")
  datSP  <- GetSQLData(dtSP,"Sablefish")
  dat1SP <- datSP[,c(-1)] 
  dat1SP <- dat1SP[,c(-3)]
  dat1SP <- dat1SP[,c(-2)]
  dat1SP <- dat1SP[,c(-6)]
  cleandataSP2<-dat1SP
  cleandataSP2$Summary_sp <- cleanf(cleandataSP2$Summary_sp)  #use the remove duplicates function
  colnames(cleandataSP2)  <- c( "Category", "Common Name", "Scientific Name" , "Count", "Weight(kg)")

  kableExtra::kable(cleandataSP2,
                    booktabs = TRUE,linesep = "",
                    format = "latex",  caption = "(ref:Table6Caption)") %>%
                    row_spec(11,  hline_after = T) %>%
                    row_spec(24,  hline_after = T) %>%
                    row_spec(28,  hline_after = T) %>%
                    kableExtra::kable_styling(font_size = 8)
```

(ref:Table7Caption) Summary of species captured by the `r boat2` during the `r yr+1`, survey standardized sets conducted at mainland inlet localities. Null values indicate the catch was not counted or weighed. No value in both weight and count indicates a trace weight recorded from a trap of less than 1 kg.
                    
```{r table7, echo=FALSE}
    options(knitr.kable.NA = '')
    dtSP   <- paste("exec procRReport_SpeciesSummary ",yr+1," ,'INLET STANDARDIZED'",sep="")
    datSP  <- GetSQLData(dtSP,"Sablefish")
    dat1SP <-  datSP[,c(-1)] 
    dat1SP <- dat1SP[,c(-3)]
    dat1SP <- dat1SP[,c(-2)]
    dat1SP <- dat1SP[,c(-6)]
    cleandataSPi2<-dat1SP
    cleandataSPi2$Summary_sp <- cleanf(cleandataSPi2$Summary_sp)  #use the remove duplicates function
    colnames(cleandataSPi2)  <- c( "Category", "Common Name", "Scientific Name" , "Count", "Weight(kg)")

    kableExtra::kable(cleandataSPi2,
                    booktabs = TRUE,linesep = "", row.names = FALSE,
                    format = "latex",  caption = "(ref:Table7Caption)") %>%
                    row_spec(3,  hline_after = T) %>%
                    row_spec(6,  hline_after = T) %>%
                    kableExtra::kable_styling(font_size = 8)
```
(ref:Table8Caption) Summary of Sablefish biological data collected during the `r yr` 
                    stratified random sets by spatial and depth stratum.

```{r table8, echo=FALSE, warning=FALSE, message=FALSE,comment=NA} 

   biosable <- rbind(newdata,biosumm2)
   #biosable <- biosable[,c(-1)] 
   colnames(biosable) <-  c("Spatial","Depth","Males","Females","Males","Females","Tagged")


   kableExtra::kable(biosable[1:7],
                    booktabs = TRUE,linesep = "",row.names = FALSE,
                    format = "latex",  caption = "(ref:Table8Caption)") %>%
               add_header_above(c("Stratum/Inlet"=3, "Proportion"=2, "Mean Fork Length(mm)"=3)) %>%
                    kableExtra::kable_styling(font_size = 10) %>%
                    row_spec(4,  bold=T, hline_after = T) %>%
                    row_spec(8,  bold=T, hline_after = T) %>%
                    row_spec(12, bold=T, hline_after = T) %>%
                    row_spec(16, bold=T, hline_after = T) %>%
                    row_spec(20, bold=T, hline_after = T) %>%
                    row_spec(25, bold=T) 
   
```
(ref:Table9Caption) Summary of Sablefish biological data collected during the `r yr+1` 
                    stratified random sets by spatial and depth stratum.

```{r table9, echo = FALSE, warning = FALSE, message = FALSE,comment = NA}
      newdata2.2 <- rbind(newdata.2,biosumm2.2)
      colnames(newdata2.2) <-  c("Spatial","Depth","Males","Females","Males","Females","Tagged")

   kableExtra::kable(newdata2.2,
                    booktabs = TRUE,linesep = "",row.names = FALSE,
                    format = "latex",  caption = "(ref:Table9Caption)") %>%
               add_header_above(c("Stratum/Inlet"=3, "Proportion"=2, "Mean Fork Length(mm)"=3)) %>%     
                    kableExtra::kable_styling(font_size = 10) %>%
                    row_spec(4,  bold=T, hline_after = T) %>%
                    row_spec(8,  bold=T, hline_after = T) %>%
                    row_spec(12, bold=T, hline_after = T) %>%
                    row_spec(16, bold=T, hline_after = T) %>%
                    row_spec(20, bold=T, hline_after = T) %>%
                    row_spec(25, bold=T)
   
```

(ref:Table10Caption) Count of tagged fish released since 1991 (including re-released) and counts of verified tag recoveries by year until December 
                     `r yr+1` including any recoveries that had no reported year. The total count of tag recoveries represent the sum of all verified                           recoveries.

```{r table10,  echo=FALSE}
  # table FishTag.dbo.WEB_TAG_REVIEW is created in procedure FishTag.dbo.Procedure5_Build_WebData
  # each year must be added
  dtBW  <-  paste("select [Release year] as [Year], Total_released as [Release], ",
                          "Rec_1991 as [91], Rec_1992 as [92], Rec_1993 as [93], ",
                          "Rec_1994 as [94], Rec_1995 as [95], Rec_1996 as [96], ",
                          "Rec_1997 as [97], Rec_1998 as [98], Rec_1999 as [99], ",
                          "Rec_2000 as [00], Rec_2001 as [01], Rec_2002 as [02], ",
                          "Rec_2003 as [03], Rec_2004 as [04], Rec_2005 as [05], ",
                          "Rec_2006 as [06], Rec_2007 as [07], Rec_2008 as [08], ",
                          "Rec_2009 as [09], Rec_2010 as [10], Rec_2011 as [11], ",
                          "Rec_2012 as [12], Rec_2013 as [13], Rec_2014 as [14], ",
                          "Rec_2015 as [15], Rec_2016 as [16], Rec_2017 as [17], ",
                          "Rec_2018 as [18], Rec_2019 as [19], Total_recovered as [Total], No_recovery_year as [No Year] ",
                          "from dbo.WEB_TAG_REVIEW order by [Release year]",sep="")
   datag <-  GetSQLData(dtBW,"FishTag")
  
   csasdown::csas_table(datag, longtable = T,
               format = "latex",  
               landscape= TRUE,
               repeat_header_text = "Continued...", 
               caption = "(ref:Table10Caption)") %>%
   kableExtra::kable_styling(font_size = 7) %>%
   column_spec(1,width  = "0.2cm") %>%
   column_spec(2,width  = "0.4cm") %>%
   column_spec(3,width  = "0.2cm") %>%
   column_spec(4,width  = "0.2cm") %>%
   column_spec(5,width  = "0.2cm") %>%  
   column_spec(6,width  = "0.2cm") %>% 
   column_spec(7,width  = "0.2cm") %>% 
   column_spec(8,width  = "0.2cm") %>% 
   column_spec(9,width  = "0.2cm") %>% 
   column_spec(10,width = "0.2cm") %>% 
   column_spec(11,width = "0.2cm") %>% 
   column_spec(12,width = "0.2cm") %>% 
   column_spec(13,width = "0.2cm") %>%
   column_spec(14,width = "0.2cm") %>%
   column_spec(15,width = "0.2cm") %>%
   column_spec(16,width = "0.2cm") %>%
   column_spec(17,width = "0.2cm") %>%
   column_spec(18,width = "0.2cm") %>%
   column_spec(19,width = "0.2cm") %>%
   column_spec(20,width = "0.2cm") %>%     
   column_spec(21,width = "0.2cm") %>%     
   column_spec(22,width = "0.2cm") %>%     
   column_spec(23,width = "0.2cm") %>%     
   column_spec(24,width = "0.2cm") %>%     
   column_spec(25,width = "0.2cm") %>%     
   column_spec(26,width = "0.2cm") %>%     
   column_spec(27,width = "0.2cm") %>%     
   column_spec(28,width = "0.2cm") %>% 
   column_spec(29,width = "0.2cm") %>%   
   column_spec(30,width = "0.2cm") %>%
   column_spec(31,width = "0.2cm") %>%
   column_spec(32,width = "0.2cm") %>%  
   column_spec(33,width = "0.2cm")    
``` 

(ref:Table11Caption) Counts of tagged fish recoveries by Groundfish management unit area (GMU).

```{r table11,  echo=FALSE}

   tagGMUc       <-  paste("select * from q_Fish_Tag_Rel_Rec_by_GMU ")
   tagGMU        <-  GetSQLData(tagGMUc,"FishTag")
   tagGMU$Area   <-  cleanf(tagGMU$Area)
 
   csasdown::csas_table(tagGMU, 
               longtable = T,
               format = "latex",  
               repeat_header_text = "Continued...", 
               caption = "(ref:Table11Caption)") %>%
   kableExtra::kable_styling(font_size = 8) %>%
               row_spec(11,  hline_after = T) %>%
               row_spec(22,  hline_after = T) %>% 
               row_spec(33,  hline_after = T) %>% 
               row_spec(44,  hline_after = T) %>% 
               row_spec(55,  hline_after = T) %>% 
               row_spec(66,  hline_after = T) %>%     
               column_spec(14, bold=T) 
```

```{r figure1, fig.cap=figure1, out.width = "450px", out.height = "600px", echo=FALSE, fig.align="center"}
      img <- paste('C:/github/surveyreport/figures/Figure_1_Report_Overview_survey_',yr+1,'.png',sep="") 
      knitr::include_graphics(img)
```

```{r figure2, fig.cap=figure2, echo=FALSE, out.width = "350px",out.height = "600px", fig.align="center"}
      img <- paste('C:/github/surveyreport/figures/Figure_2_Report_S1_S5_', yr,yr+1,'.png'  ,sep="")
      knitr::include_graphics(img)
```

```{r figure3, fig.cap=figure3, out.width = "400px", echo=FALSE, fig.align="center"}
      img <- paste('C:/github/surveyreport/figures/Figure_3_Report_Inlets_',yr+1,'.png',sep="")
      knitr::include_graphics(img)
```

```{r figure4, fig.cap=figure4, out.width = "400px", echo=FALSE, fig.align="center"}
      img <- paste('C:/github/surveyreport/figures/Figure_4_gearelements.png',sep="") 
      knitr::include_graphics(img)
```
```{r figure5, fig.cap=figure5, echo=FALSE, out.width = "400px",out.height = "600px"}
   png("C:/github/surveyreport/figures/Figure_5_cpue.png", width = 468, height = 668)      # -- starts writing a png to figure folder 

   dtStRS  <- "select * from dbo.GENERIC_GFBIO_TRAPS where [Spatial.Stratum] not like '%Quatsino Sound%' order by year"
   datStRS <- GetSQLData(dtStRS,"Sablefish") 
   odbcCloseAll()

  
  par(mfcol=c(9,2), mar=c(2,2,1,1), oma=c(3,2,1,1))     # -- set margins:  par(mar=c(bottom,left,top,right), cex=size of font)
  datRD   <- datStRS[ datStRS$SABLE.SET.TYPE=="StRS", ] # -- pick out the random sets
  dat     <- datRD[ ! is.na(datRD$SABLE.SET.TYPE), ]
  yrs     <- unique(datRD$year)                         # -- get unique years
  nyrs    <- length(yrs)
  
  data.cv <- data.frame( year = numeric(),
                         value1 = numeric(),
                         value2= numeric(),
                         value3= numeric()
                       )
  data.mn <- data.frame( year = numeric(),
                         value1 = numeric(),
                         value2= numeric(),
                         value3= numeric()
                       )

  # iterate through the years building depth boxplots
  for (i in 1:nyrs)
     {    yrdat <- datRD[datRD$year==yrs[i],]   # -- get the year dataset
          bxdat <- split(yrdat$CPUE.SABLE.COUNT / yrdat$CPUE.TRAPS,  as.character(yrdat$SABLE.DEPTH.GROUP))  # -- split the data by depth 
          xpos  <- boxplot(bxdat, boxwex = 0.20, medcol=c("black"), medlwd=1, outline=TRUE, ylim=c(0,80), cex=0.5)
          text(3,90,c(yrs[i]),cex = 0.5)

          dpth.mean <- sapply(bxdat, mean, na.rm=T)  #  add the mean by depth 
          std.dev   <- sapply(bxdat, sd, na.rm=T)
          
          names(data.cv)<- c("year", "RD1", "RD2", "RD3")  # -- coefficient of variation Cv = Standard Deviation / Mean
          names(data.mn)<- c("year", "RD1", "RD2", "RD3")  # -- store mean counts by depth
          data.cv <-rbind(data.cv,c(yrs[i],round(std.dev/dpth.mean,2)))
          data.mn <-rbind(data.mn,c(yrs[i],round(dpth.mean,0)))
          
          points(dpth.mean, pch=16, col="red", cex=1)
          abline(h=c(20,40,60,80), lty=2, col='gray50')    #  add some reference lines lty of 2 is dashed line
          
          par(usr=c(0,1,0,1))
          text(0.89,0.9,paste(yrs[i]),cex=1.2)  # label the years
          
          if (i==1)     {   # -- add labels
             mtext( side=2, line=1, cex=1.0, outer=T, "count per trap" ,adj=0.5)
             mtext( side=1, line=1, cex=1.0, outer=T, "depth stratum, StRS sets" ,adj=0.5) }
        
       }
          par(usr=c(0,1,0,1))    
          text(0.13,0.69, "RD1:  Shallow 100-250 fa")
          text(0.13,0.8,  "RD2:  Mid     250-450 fa")
          text(0.13,0.9,  "RD3:  Deep    450-750 fa")
          
          dev.off() 
          img <- paste('C:/github/surveyreport/figures/Figure_5_cpue.png',sep="") 
                 knitr::include_graphics(img)

```

```{r figure6, fig.cap=figure6, echo=FALSE, out.width = "400px", out.height = "500px", fig.align="center"}
      knitr::opts_chunk$set(out.height = "\\textheight",  out.width = "\\textwidth")

      #  L E N G T H    H I S T O G R A M  
      #  Sablefish.dbo.procReport_Survey_LenMF pulls length data from table GFBIO_SABLEBIO_VW 
      #  procedure:  Build_BIO_Sablefish_Tables 
   
      png("C:/github/surveyreport/figures/Figure_6_lengths.png", width = 800, height = 924) # -- starts writing a png to figure folder
      
      par(mfcol=c(2,1), mar=c(4,4,1,1), oma=c(3,2,1,1), cex=1.0)  # -- mar(bottom, left, top, and right)

     	a2        <-   hist(females2, breaks = brk2, plot=F)
    	b2        <-   hist(males2,   breaks = brk2, plot=F)  # draw the histogram with the specified number of bins
    	
    	plot(b2, col=rgb(0,0,1,0.5), border="white", main="", xlab="length(cm)", xlim=c(30,100))
    	plot(a2, col=rgb(1,0,1,0.5), border="white", add = TRUE)
    	box()
    	
      panLab(0.79,0.4,paste(" StRS sets",  sep=""), cex=1.1)  # -- Labels
    	panLab(0.19,0.98,"Sablefish males")
    	panLab(0.79,0.98,"Sablefish females")
    	panLab(0.19,0.9,bquote(bold(n)==.(tm2)))
    	panLab(0.79,0.9,bquote(bold(n)==.(tf2)))
    	panLab(0.19,0.8,bquote(bolditalic(bar(x))==.(mLm2)))
    	panLab(0.79,0.8,bquote(bolditalic(bar(x))==.(mLf2)))
    	panLab(0.19,0.7,bquote(bold(sigma)==.(stdm2)) )
    	panLab(0.79,0.7,bquote(bold(sigma)==.(stdf2)) )

     #  M E A N   L E N G T H   P L O T 
     #  Sablefish.dbo.rocRReport_Survey_LenAvg pulls length data from table GFBIO_SABLEBIO_VW from 
     #  procedure:  Build_BIO_Sablefish_Tables
     
     lenstats  <- "exec procRReport_Survey_LenAvg"
     dat       <- GetSQLData(lenstats,"Sablefish")
     fdat      <- dat[dat$sex==2,]
     mdat      <- dat[dat$sex==1,]
     format(fdat$count/(fdat$count+mdat$count),digits=2)
     format(mdat$count/(fdat$count+mdat$count),digits=2)
     MxSeam    <- max(dat$AvL)
    
     plot(fdat$YEAR,fdat$AvL,pch=2, ylim=c(50,MxSeam+5),xlim=c(2003,yr+1), ylab="avg length (cm)",xlab="year", col=rgb(1,0,1,0.6))
     lines(fdat$YEAR,fdat$AvL,lwd=1,lty=2, col=rgb(1,0,1,0.6))    # -- plot points and lines
     
     points(mdat$YEAR,mdat$AvL,pch=16,col=rgb(0,0,1,0.6)) 
     lines(mdat$YEAR,mdat$AvL,lwd=1,lty=1,col=rgb(0,0,1,0.6))

     text(fdat$YEAR,fdat$AvL+1,fdat$count,cex=0.7)
     text(mdat$YEAR,mdat$AvL+1,mdat$count,cex=0.7)
     text(fdat$YEAR,53,format(mdat$count/fdat$count,digits=1),cex=0.8)
     text(2003,51,"M:F",cex=1.0)
     par(usr=c(0,1,0,1))  # -- set up the plot margins
        
     legend(0.035,1, c("  Sablefish Females","  Sablefish Males"), lty=c(2,1), lwd=1, bty="n", col=c(rgb(1,0,1,0.6), rgb(0,0,1,0.6)))
     legend(0.035,1, c("",""), pch=c(2,16), bty="n", col=c(rgb(1,0,1,0.6),rgb(0,0,1,0.6)))
     panLab(0.79,0.95,paste("StRS 2003-", yr+1, sep=""), cex=1.1)
     
     dev.off() 
     img <- paste('C:/github/surveyreport/figures/Figure_6_lengths.png',sep="") 
            knitr::include_graphics(img)
``` 

```{r figure7, fig.cap=figure7, echo=FALSE, warning=FALSE, message=FALSE,out.width = "400px", out.height = "500px", fig.align="center"}
    
    # L E N G T H     W E I G H T 
    # Sablefish.dbo.procR_Survey_Sablefish_LenWt_shiny queries table GFBIO_SABLEBIO_VW for survey length data	
    png("C:/github/surveyreport/figures/Figure_7_Lenwt.png", width = 800, height = 924) # -- starts writing a png to figure folder

    lenWT     <- "exec procR_Survey_Sablefish_LenWt_shiny"
    lenWTdat1 <- GetSQLData(lenWT,"Sablefish")

    par(mfcol = c(2,2))
    lenWTdat  <- lenWTdat1[lenWTdat1$YEAR==yr,]

    for (i in 1:2) {
         ylim <- c(min(lenWTdat$weight),max(lenWTdat$weight))
         xlim <- c(min(lenWTdat$length),max(lenWTdat$length))    
         lbls <- c(paste(yr,":  Males","",sep=""),paste(yr,":  Females","",sep=""))
   
         t    <- length(lenWTdat$length[lenWTdat$sex==i])                    
         fit1 <- lm(log(weight)~log(length), data=lenWTdat[lenWTdat$sex==i ,])
         a    <- round(exp(fit1$coef[1]),7)
         b    <- round(fit1$coef[2],3)
         Wt   <- (a * (0:xlim[2])^b)  

      plot(jitter(lenWTdat$length[lenWTdat$sex==i],2), 
           jitter(lenWTdat$weight[lenWTdat$sex==i],2), 
           pch=16, col="black", cex=0.5,
           xlab="     Fork length (cm)", ylab="   Round weight (kg)", 
           main=paste(lbls[i]), xlim=c(20,100), ylim=c(0,12))      
           lines(0:xlim[2], Wt, col="darkgrey", lwd=2) 
           
      mw     <- format(round(mean(lenWTdat$weight[lenWTdat$sex==i],na.rm=T),1),nsmall=1)
      par(usr=c(0,1,0,1))
      text(0.3,0.9, bquote(bold(n)==.(t)))   # -- number
      text(0.3,0.8, bquote(bolditalic(bar(W))==.(mw))) # -- mean weight
      text(0.33,0.7,bquote(bold(a)==.(a)))  # -- a
      text(0.32,0.6,bquote(bold(b)==.(b)))  # -- b
    }
    
    lenWTdat.2  <- lenWTdat1[lenWTdat1$YEAR==yr+1,]

    for (i in 1:2) {
      ylim.2 <- c(min(lenWTdat.2$weight),max(lenWTdat.2$weight))
      xlim.2 <- c(min(lenWTdat.2$length),max(lenWTdat.2$length))    
      lbls.2 <- c(paste(yr+1,":  Males","",sep=""),paste(yr+1,":  Females","",sep=""))
   
      t.2 <- length(lenWTdat.2$length[lenWTdat.2$sex==i])                    
      fit1.2 <- lm(log(weight)~log(length), data=lenWTdat.2[lenWTdat.2$sex==i ,])
      a.2 <- round(exp(fit1.2$coef[1]),7)
      b.2 <- round(fit1.2$coef[2],3)
      Wt.2 <- (a * (0:xlim.2[2])^b)  

      plot(jitter(lenWTdat.2$length[lenWTdat.2$sex==i],2), 
      jitter(lenWTdat.2$weight[lenWTdat.2$sex==i],2), pch=16, col="black", cex=0.5,
         xlab="     Fork length (cm)", ylab="   Round weight (kg)", main=paste(lbls.2[i]), xlim=c(20,100), ylim=c(0,12))      
         lines(0:xlim.2[2], Wt.2, col="darkgrey", lwd=2)      
      mw.2   <-  format(round(mean(lenWTdat.2$weight[lenWTdat.2$sex==i],na.rm=T),1),nsmall=1)
      par(usr=c(0,1,0,1))
      text(0.3,0.9,bquote(bold(n)==.(t.2)))   # number
      text(0.3,0.8,bquote(bolditalic(bar(W))==.(mw.2))) # mean weight                                                                                                                                                                                 
      text(0.33,0.7,bquote(bold(a)==.(a.2)))  # a
      text(0.32,0.6,bquote(bold(b)==.(b.2)))  # b
    }
   dev.off() 
   img <- paste('C:/github/surveyreport/figures/Figure_7_Lenwt.png',sep="") 
          knitr::include_graphics(img)
```

```{r figure8, fig.cap=figure8, out.width = "400px", echo=FALSE, fig.align="center"}
      img <- paste('C:/github/surveyreport/figures/Figure_8_sublegals.png',sep="")
      knitr::include_graphics(img)
```


```{r figure9, fig.cap=figure9, echo=FALSE, out.width = "400px", out.height = "500px",fig.align="center"}
   # dt  <-  ("exec procRKnitr_Survey_proportions_at_age")  run this procedure to create table first.
   # sql server procedure:  procRReport_Survey_proportions_at_age which pulls age data from 
   # GFBIOSQL.dbo.b21_samples and b22_specimens

   png("C:/github/surveyreport/figures/Figure_9_ages.png", width = 800, height = 924)  # -- starts writing a png to figure folder

   dt   <-  paste("select * from Report_Survey_GFBIO_Age_MF_Prop where SetType='StRS' and Year<=", yr+1, sep="")
   dat  <-  GetSQLData(dt,"Sablefish")

   par(mfrow=c(2,1),cex=0.9)     # -- two vertical plots
   involve  <-  c()
   involve  <-  unique(dat$Year)
   maxyr    <-  max(involve)
   minyr    <-  min(involve)

   # -- plot bubbles for males
   plot(dat$Year, dat$Age, type="n", xlab=" Year", ylab="",main="Males", ylim=c(0,42), xlim=c(minyr,maxyr))      
   symbols(dat$Year, dat$Age, circles=pi*(dat$Male_Proportion),inches=0.3, add=T, col="light grey")

   for (maleyr in involve){
    h      <-  unique(dat$Male_Yr_Total[dat$Year==maleyr])
    text(maleyr + 0.15, 40, bquote(.(h)))    
    text(maleyr + 0.35, dat$Age[dat$m==1 & dat$Year==maleyr],dat$Age[dat$m==1 & dat$Year==maleyr],col="red",cex=1.3, font=2)}
    
   # -- plot bubbles for females
   plot(dat$Year, dat$Age, type="n",xlab=" Year", ylab="", main="Females", ylim=c(0,42), xlim=c(minyr,maxyr))      
   symbols(dat$Year, dat$Age, circles=pi*(dat$Female_Proportion),inches=0.3, add=T,col="light grey")

   for (femaleyr in involve){
    h   <-   unique(dat$Female_Yr_Total[dat$Year==femaleyr])
    text(femaleyr + 0.15, 40, bquote(.(h)))   
    text(femaleyr + 0.15, dat$Age[dat$f==1 & dat$Year==femaleyr],dat$Age[dat$f==1 & dat$Year==femaleyr],col="red",cex=1.3, font=2)}

    mtext(paste("Age","",sep=""), SOUTH<-2,  line=-1, adj=0.5,cex=1.0,  outer=TRUE)  # -- outside label
   
    dev.off() 
    img <-   paste('C:/github/surveyreport/figures/Figure_9_ages.png',sep="")   # -- retrieve png from figures folder
             knitr::include_graphics(img)
```

```{r figure10, fig.cap=figure10, echo=FALSE, out.width = "400px", out.height = "500px", fig.align="center"}

   png("C:/github/surveyreport/figures/Figure_10_agesOF.png", width = 800, height = 924)  # -- starts writing a png to figure folder
   # sql server procedure:  procRReport_Survey_proportions_at_age which pulls age data from 
   # GFBIOSQL.dbo.b21_samples and b22_specimens
   dt      <- paste("select * from Report_Survey_GFBIO_Age_MF_Prop where SetType='OFFSHORE STANDARDIZED' and Year<= 2009", sep="")
   dat     <- GetSQLData(dt,"Sablefish")
   
   par(mfrow=c(2,1))     # -- two vertical plots
   involve  <-  c()
   involve  <-  unique(dat$Year)
   mxyr     <-  max(involve)
   mnyr     <-  min(involve)

   plot(dat$Year,dat$Age, type="n",xlab=" Year", ylab="", main="Males", ylim=c(0,42), xlim=c(mnyr,mxyr))  #  plot bubbles 
   symbols(dat$Year, dat$Age, circles=pi*(dat$Male_Proportion),inches=0.3, add=T,col="light grey")
   
   # Males:  post total numbers of aged fish across the top and highest proportions label in red
   for (maleyr in involve){
         h   <-   unique(dat$Male_Yr_Total[dat$Year==maleyr])
         text(maleyr+0.15,40,bquote(.(h)),cex=0.9)
    if (maleyr!= 2010) {
         text(maleyr+0.35,dat$Age[dat$m==1 & dat$Year==maleyr],dat$Age[dat$m==1 & dat$Year==maleyr],col="red",cex=1.5) }
    }
    
   plot(dat$Year,dat$Age, type="n",xlab=" Year", ylab="", main="Females", ylim=c(0,42), xlim=c(mnyr,mxyr))   #  plot bubbles   
   symbols(dat$Year, dat$Age, circles=pi*(dat$Female_Proportion),inches=0.3, add=T,col="light grey")
   
   # Females: post total numbers of aged fish across the top and highest proportions label in red
   for (femaleyr in involve){
     h <- unique(dat$Female_Yr_Total[dat$Year==femaleyr])
     text(femaleyr + 0.15,40,bquote(.(h)),cex=0.9)   
     text(femaleyr + 0.15,dat$Age[dat$f==1 & dat$Year==femaleyr],dat$Age[dat$f==1 & dat$Year==femaleyr],col="red",cex=1.5)    
    }
    mtext(paste("Age","",sep=""), SOUTH<-2,  line=-1, adj=0.5,cex=0.9,  outer=TRUE)  # outside label
        dev.off() 
    img <-   paste('C:/github/surveyreport/figures/Figure_10_agesOF.png',sep="")   # -- retrieve png from figures folder
             knitr::include_graphics(img)
```

```{r figure11, fig.cap=figure11, out.width = "400px", out.height = "500px", fig.align="center"}
   png("C:/github/surveyreport/figures/Figure_11a_coplot.png", width = 920, height = 424) # starts writing a png to file
   

      # table SEABIRD_ReportCoplot created in the Sablefish.dbo.Build_Seabird_tables procedure
      sbecp        <- paste("select * from SEABIRD_ReportCoplot where Year in(",yr,",",yr+1,")",sep="")
      ctddat       <- GetSQLData(sbecp,"Sablefish") 
      odbcCloseAll()
      
      par(mar=c(1,1,1,1))           # -- par(mar=c(bottom,left,top,right) 
      yrdat     <-  ctddat[ctddat$Year==yr,]
      given.lat <-  matrix(c(48,48,49,49,50,50,51,51,52,52,53,53,54,54), nrow = 7, ncol=2, byrow=TRUE)
      coplot(temperature  ~ depth| lat, data = yrdat, 
             col = "red",  pch = 19, xlim=c(200,1400), ylim=c(2,10),
             given.v = given.lat,
             show.given=FALSE, rows=1, cex=1.5, 
             xlab=c("Average Depth (m)",""),ylab="Average Temperature (C)")

             n48 <- length(unique(yrdat$Sets[yrdat$lat == 48]))  # count number of sets in lat band
             n49 <- length(unique(yrdat$Sets[yrdat$lat == 49]))
             n50 <- length(unique(yrdat$Sets[yrdat$lat == 50]))
             n51 <- length(unique(yrdat$Sets[yrdat$lat == 51]))
             n52 <- length(unique(yrdat$Sets[yrdat$lat == 52]))
             n53 <- length(unique(yrdat$Sets[yrdat$lat == 53]))
             n54 <- length(unique(yrdat$Sets[yrdat$lat == 54]))

      
      labels   <-   c(n48,n49,n50,n51,n52,n53,n54)
      for(j in 1:7) { text((280*j)-(100*(j-1)),8,paste("n=",labels[j],sep=""))  }
      
      dev.off() 

               
      png("C:/github/surveyreport/figures/Figure_11b_coplot.png", width = 920, height = 424) # starts writing a png to file
      yrdat<-ctddat[ctddat$Year==yr + 1,]
      given.lat <-matrix(c(48,48,49,49,50,50,51,51,52,52,53,53,54,54),nrow = 7, ncol=2, byrow=TRUE)
      coplot(temperature  ~ depth| lat, data = yrdat, 
             col = "red",  pch = 19, xlim=c(200,1400), ylim=c(2,10),
             given.v = given.lat,
             show.given=FALSE, rows=1, cex=1.5, 
             xlab=c("Average Depth (m)",""),ylab="Average Temperature (C)")

             n48<-length(unique(yrdat$Sets[yrdat$lat == 48]))  # count number of sets in lat band
             n49<-length(unique(yrdat$Sets[yrdat$lat == 49]))
             n50<-length(unique(yrdat$Sets[yrdat$lat == 50]))
             n51<-length(unique(yrdat$Sets[yrdat$lat == 51]))
             n52<-length(unique(yrdat$Sets[yrdat$lat == 52]))
             n53<-length(unique(yrdat$Sets[yrdat$lat == 53]))
             n54<-length(unique(yrdat$Sets[yrdat$lat == 54]))

     labels <- c(n48,n49,n50,n51,n52,n53,n54)
     for(j in 1:7) { text((280*j)-(100*(j-1)),8,paste("n=",labels[j],sep=""))  }
     dev.off() 

     require('magick')

  # Read external images
    uno <- image_read("C:/github/surveyreport/figures/CoPlotTopMain.png")
    one <- image_read("C:/github/surveyreport/figures/Figure_11a_coplot.png")
    two <- image_read("C:/github/surveyreport/figures/Figure_11b_coplot.png")
    imgs = c(uno, one, two)

  # concatenate them left-to-right (use 'stack=T' to do it top-to-bottom)
    side_by_side = image_append(imgs, stack=T)

  # save the png
    image_write(side_by_side, path = "C:/github/surveyreport/figures/Figure_11_coplot.png", format = "png")

    img <-   paste('C:/github/surveyreport/figures/Figure_11_coplot.png',sep="")   # -- retrieve png from figures folder
             knitr::include_graphics(img)

```


```{r figure12, fig.cap=figure12, echo=FALSE,fig.width=16, fig.height=9}
    # table SEABIRD_ReportLinePlot created in the Sablefish.dbo.Build_Seabird_tables procedure
    
    png("C:/github/surveyreport/figures/Figure_12_seabirdavg.png", width = 800, height = 924) # starts writing a png to file
    ctddt  <-  "select * from SEABIRD_ReportLinePlot"
    ctd    <-  GetSQLData(ctddt,"Sablefish") 
  
    # set margins:  par(mar=c(bottom,left,top,right), cex=size of font)
    par(mfcol=c(7,2), mar=c(2,2,1,1), oma=c(3,2,1,1))
    yrs    <-  unique(ctd$Year)

  for (i in yrs){  
       plot(ctd$avgtemp[ctd$depth    == "Shallow" & ctd$Year == i]~ctd$latitude[ctd$depth == "Shallow" & ctd$Year==i], 
                                         col =  "gray75", type="l",lwd=2, ylim=c(0,14), xlim=c(48,55))
       points(ctd$avgtemp[ctd$depth  == "Shallow" & ctd$Year == i]~ctd$latitude[ctd$depth == "Shallow" & ctd$Year==i],col="gray75")
    
       lines(ctd$latitude[ctd$depth  == "Mid" & ctd$Year == i],ctd$avgtemp[ctd$depth == "Mid" & ctd$Year==i],col="gray45",lwd=2)
       points(ctd$latitude[ctd$depth == "Mid" & ctd$Year == i],ctd$avgtemp[ctd$depth == "Mid" & ctd$Year==i],col="gray45")

       lines(ctd$latitude[ctd$depth  == "Deep" & ctd$Year == i],ctd$avgtemp[ctd$depth == "Deep" & ctd$Year==i],col="black",lwd=2)
       points(ctd$latitude[ctd$depth == "Deep" & ctd$Year == i],ctd$avgtemp[ctd$depth == "Deep" & ctd$Year==i],col="black")

       par(usr=c(0,1,0,1))
       text(0.89,0.9,paste(i),cex=1.2)
   
       legend(0.035,1, c("  Shallow 100-250 fa","  Mid 250-450 fa",  "  Deep 450-750 fa"), col=c("gray75","gray45","black"), 
                                                                                           lty=c(1,1,1), lwd=2, bty="n")
       legend(0.035,1, c("","",""), pch=c(16,16,16), col=c("gray75","gray45", "black"),bty="n")
    }

  mtext( side=2, line=1, cex=1.0, outer=T, "average temperature" , adj=0.5)
  mtext( side=1, line=1, cex=1.0, outer=T, "latitude band" ,       adj=0.5)
     
  dev.off() 
    img  <- paste('C:/github/surveyreport/figures/Figure_12_seabirdavg.tiff',sep="") 
            knitr::include_graphics(img)

```
