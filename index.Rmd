---
title: "Summary of the Annual 2018 and 2019 Sablefish (*Anoplopoma fimbria*) Trap Surveys, October 9 - November 19, 2018 and October 8 - November 25, 2019"
year: 2020
report_number: nnn
author: |
  Lacko. C. Lisa and
  Schon M. Acheson and
  Brendan M. Connors
author_list: "Lacko, L.C. and Acheson, S.M. and Connors, B.M."
region: Pacific Region
isbn: ""
address: |
     Pacific Biological Station\
     Fisheries and Oceans Canada, 3190 Hammond Bay Road\
     Nanaimo, British Columbia, V9T 6N7, Canada\
phone: "(555) 555-5555"
author_footnote: "Email: Lisa.Lacko@dfo-mpo.gc.ca | telephone: (250) 756-5555"
abstract: |
  This document describes sampling activities and summarizes results from the 2018 and 2019 British Columbia Sablefish research and assessment surveys. It is also intended to provide a historical reference for researchers. The two surveys utilized the same sampling strategies at stratified random (StRS) sites and all traditional inlet sites.   The random component was comprised of StRS sets at five depth-stratified areas and the traditional component employed standardized sets at four inlet localities on the mainland. 
  
  As in previous surveys, biological sampling for sablefish included collection of length, weight, sex, maturity and age structures. Sablefish were randomly sampled from every third trap on all sets, up to  a maximum sample size of 60 sablefish. Biological samples (length, weight, sex, maturity and otoliths) were taken for yelloweye rockfish, shortraker rockfish and rougheye/blackspotted rockfish species from catch in all traps.  In addition, genetic samples were taken for the rougheye/blackspotted rockfish complex and yelloweye rockfish.  Length and weight measurements were collected from all Pacific halibut while only lengths were obtained from Pacific sleeper sharks. 
  
  A sablefish tag and release study has been conducted annually since 1991 and was continued in 2018 and 2019. Sablefish were selected randomly for tag and release from every third trap up to a maximum of 125 fish. 
  
  In total, 58,415 sablefish were caught in 2018, of which 5,741 were used for biological samples and 11,965 were tagged and released.  Of those released, 208 were recaptured tagged fish.  Five recaptured fish were retained for samples and the remaining 203 were fitted with a new tag and released back into the water. In 2019, a total of 78,836 sablefish were caught, of which 5,659 were used for biological samples and 12,042 were tagged and released.  Of those released, 154 were recaptured tagged fish.  Two recaptured fish were retained for samples and the remaining 152 were fitted with a new tag and released back into the water.  
  
  Other than sablefish, 53 and 18 taxonomic groups were represented in the 2018 catches from StRS sets and mainland inlet localities, respectively.  In 2019, 50 and 12 taxonomic groups other than sablefish were captured from StRS sets and mainland inlet localities, respectively. 
  Catch per unit effort (CPUE) is an important product from this survey. They can be used to infer population trends which are critical data elements used in stock assessment.  CPUE from stratified random sets in the shallow depth stratum have shown a gradual decline in numbers of fish per trap from 2003 to 2009. CPUE rose again in 2010 and gradually declined from 2011 through 2014 to levels seen in 2009. An increase occurred again in 2015 and 2016, similar to those in 2010 and 2011.   Last, CPUE surged in 2017, 2018 and 2019 to historic levels.  
  
  Within all years, the highest CPUE was achieved in the middle depth stratum.  CPUE showed a gradual decline from 2003 to 2010, then an increase in 2011 to those levels seen in 2004.  CPUE dropped once again and fluctuated during 2012, 2013 and 2014.   In 2015, a significant rise in numbers of fish per trap occurred, followed by a drop in 2016 to levels seen in 2004.  Finally, a significant steady increase was seen in 2017, 2018 and 2019.  
  
  CPUE in the deep depth stratum (RD3) increased from 2003 to 2006 but declined in 2007.  From 2008 through 2016, CPUE declined and remained low.  A slight increase appeared in 2017, followed by another in 2018.  In 2019, CPUE returned to those seen in 2006.
  

abstract_other: |
  Voici le résumé. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
output:
 csasdown::techreport_pdf:
   french: false
type:
  techreport
# ------------
# End of options to set
knit: bookdown::render_book
site: bookdown::bookdown_site
link-citations: true
bibliography: bib/refs.bib
csl: csl/csas.csl
lot: true
lof: true
# Any extra LaTeX code for the header:
# header-includes:
# - \usepackage{tikz}
header-includes: \usepackage{pdflscape}
---

```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
library(knitr)
if (is_latex_output()) {
  knitr_figs_dir <- "knitr-figs-pdf/"
  knitr_cache_dir <- "knitr-cache-pdf/"
  fig_out_type <- "png"
} else {
  knitr_figs_dir <- "knitr-figs-docx/"
  knitr_cache_dir <- "knitr-cache-docx/"
  fig_out_type <- "png"
}
fig_asp <- 0.618
fig_width <- 9
fig_out_width <- "6in"
fig_dpi <- 180
fig_align <- "center"
fig_pos <- "htb"
opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = knitr_figs_dir,
  cache.path = knitr_cache_dir,
  fig.asp = fig_asp,
  fig.width = fig_width,
  out.width = fig_out_width,
  echo = FALSE,
  #  autodep = TRUE,
  #  cache = TRUE,
  cache.comments = FALSE,
  dev = fig_out_type,
  dpi = fig_dpi,
  fig.align = fig_align,
  fig.pos = fig_pos
)
options(xtable.comment = FALSE)
options(kableExtra.latex.load_packages = FALSE)
```

```{r load-libraries, cache=FALSE}
# add other packages here:
library(csasdown)
message("year = ", rmarkdown::metadata$year)
#browser()
yr  <-  2018

library(RODBC)
library(knitr)
library(magick)
library(excelR)
library(gapminder)
library(ggplot2)
library(dplyr)        # transform and summarize tabular data
library(xtable)       # produces tables
library(kableExtra)   # produces html tables with scrollbars, etc
library(pacman)       # produces numbered tables and figures in order to reference them
 #  if (!require("pacman")) install.packages("pacman")
 #  pacman::p_load(knitr, captioner, bundesligR, stringr)
library(bookdown)
library(tableHTML)
library(Rmisc)
library(cowplot)

#  ----   G L O B A L --- F U N C T I O N S ---------------------------------

  GetSQLData <- function(strSQL,strDbName) {    # connect to SQL Server
            cnn <- odbcDriverConnect(paste("Driver={SQL Server};Server=DFBCV9TWVASP001;", 
                                         "Database=",
                                          strDbName,";
                                          Trusted_Connection=Yes",
                                          sep=""))
            dat <- sqlQuery(cnn, strSQL)
            odbcClose(cnn)
            return(dat) 
                                            }
  
  panLab <- function( x, y, txt, ... ) { # Allows text to be placed at 0<x<1, 0<y<1)
            usr <- par( "usr" )
            par( usr=c(0,1,0,1) )
            text( x, y, txt, ... )
            par( usr=usr )
            #return( NULL )
            }
  
  cleanf <- function(x){     # function to remove duplicates
            oldx <- c(FALSE, x[-1]==x[-length(x)])  # is the value equal to the previous
            res <- x
            res[oldx] <- NA
            return(res)
            } 
  
  simpleCap <- function(x) {  # add capital first letter to each word
            s <- strsplit(x, " ")[[1]]
            paste(toupper(substring(s, 1,1)), substring(s, 2),
            sep="", 
            collapse=" ")
            }
  
  firstup <- function(x) {   # add capital first letter to first word
            substr(x, 1, 1) <- toupper(substr(x, 1, 1))
            x
            }
  
  format_cells <- function(df, rows ,cols, value = c("italics", "bold", "strikethrough")){

  # select the correct markup
  map    <- setNames(c("*", "**", "~~"), c("italics", "bold", "strikethrough"))
  markup <- map[value]  
  
  for (r in rows){
        for(c in cols){
            df[[c]] <- as.character( df[[c]])  # -- make sure values are not factors
            df[r, c] <- paste0(markup, df[r, c], markup)  # -- Update formatting
                      }
                 }
           return(df)
  }
  

```

```{r, echo=FALSE}
   inline_hook <- function(x) {  # -- for inline text where numbers are larger 
      if (is.numeric(x)) {
            format(x, digits = 2)
                         } else x
      }
  knitr::knit_hooks$set(inline = inline_hook)
```

```{r SurveyDetails, echo=FALSE}  
   # -- INTRODUCTION DETAILS --

   details     <- paste("select VESSEL_NAME as Vessel, CAPTAIN, ",
                        "LEFT(CONVERT(varchar, START_DATE, 100), 7) + ' - ' ",
                        "+ LEFT(CONVERT(varchar, END_DATE, 100), 7) AS [Trip Dates], ",
                        "COUNT([SET]) AS [Count of Sets] ",
                        "from  dbo.GFBIO_RESEARCH_TRIPS ",
                        "where year IN( ", yr ,",", yr + 1 ,") ", 
                        "group by ",
                        "VESSEL_NAME, CAPTAIN,  ",
                        "LEFT(CONVERT(varchar, START_DATE, 100),7) + ' - ' + ",
                        "LEFT(CONVERT(varchar, END_DATE, 100),7)", 
                         sep="")
   #sd          <- GetSQLData(details,"Sablefish")  # -- survey details
   sd     <- read.csv("c:/github/surveyreport/standaloneData/index01_SurveyDetails.csv",header=T)
   
   boat        <- simpleCap(tolower(sd[1,1]))      # -- vessel name 1
   boat2       <- simpleCap(tolower(sd[2,1]))      # -- vessel name 2
   
   captain     <- simpleCap(tolower(sd[1,2]))      # -- captain name 1
   captain2    <- simpleCap(tolower(sd[2,2]))      # -- captain name 2
   captain2    <- "Albert (Deacon) Melnychuk"
   
   dates       <- sd[1,3]           # -- survey start and end dates 1
   dates2      <- sd[2,3]           # -- survey start and end dates 2
   
   setcnt      <- sd[1,4]           # -- survey set count 1
   setcnt2     <- sd[2,4]           # -- survey set count 2
   
   avgC        <- paste("select ROUND(AVG(TOTAL), 0) AS YrAvg ",
                        "from   dbo.TableA2_Annual_sablefish_Landing_in_Can_waters_2 ",
                        "where (year <= ", yr+1, ") and (year >= ",yr - 8,")", sep="")
   #avgTen      <- GetSQLData(avgC,"Sablefish")    # -- average catch last 10 years
   avgTen      <- read.csv("c:/github/surveyreport/standaloneData/index02_10YearAvgCatch.csv",header=T)
   
   
   tp          <- paste("select ROUND(TRAP / TOTAL * 100, 0) AS TrapPer ",
                        "from dbo.TableA2_Annual_sablefish_Landing_in_Can_waters_2 ",  
                        "where  (year = ", yr, ")  group by ROUND(TRAP / TOTAL * 100, 0), TOTAL", sep="")
   #trapP       <- GetSQLData(tp,"Sablefish")        # -- trap gear catch ratio
   trapP      <- read.csv("c:/github/surveyreport/standaloneData/index03_TrapRatio.csv",header=T)
   
   lp          <- paste("select  ROUND(LONGLINE / TOTAL * 100, 0) AS LonglinePer from ",  
                         " dbo.TableA2_Annual_sablefish_Landing_in_Can_waters_2  ",
                         "where  (year = ", yr, ") group by ROUND(LONGLINE / TOTAL * 100, 0), TOTAL", sep="")
   #LonglineP   <- GetSQLData(lp,"Sablefish")        # -- longline gear catch ratio
   LonglineP   <- read.csv("c:/github/surveyreport/standaloneData/index04_LonglineRatio.csv",header=T)
   

   tp2         <- paste("select ROUND(TRAP / TOTAL * 100, 0) AS TrapPer ",
                        "from dbo.TableA2_Annual_sablefish_Landing_in_Can_waters_2 ",  
                        "where  (year = ", yr + 1, ")  group by ROUND(TRAP / TOTAL * 100, 0), TOTAL", sep="")
   #trapP2     <- GetSQLData(tp2,"Sablefish")      # -- trap gear catch ratio
   trapP2      <- read.csv("c:/github/surveyreport/standaloneData/index05_TrapRatio.csv",header=T)
   
   lp2         <-  paste("select  ROUND(LONGLINE / TOTAL * 100, 0) AS LonglinePer from ",  
                         "dbo.TableA2_Annual_sablefish_Landing_in_Can_waters_2  ",
                         "where  (year = ", yr + 1, ") group by ROUND(LONGLINE / TOTAL * 100, 0), TOTAL", sep="")
   #LonglineP2 <- GetSQLData(lp2,"Sablefish")      # -- longline gear catch ratio 
   LonglineP2  <- read.csv("c:/github/surveyreport/standaloneData/index06_LonglineRatio.csv",header=T)
   
   # -- F I G U R E   C A P T I O N S  function ------------------------------------------------
   figure_nums <-  captioner::captioner(prefix = "Figure")
   fg.ref      <-  function(x) {    # another method on how to number figures
                                     stringr::str_extract(figure_nums(x), "[^.]*")}

```

