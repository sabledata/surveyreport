---
title: "Summary of the Annual 2018 and 2019 Sablefish (*Anoplopoma fimbria*) Trap Survey, October 9 - November 19, 2018 and October 9 - November 19, 2019"
year: 2020
report_number: nnn
author: |
  Lacko. C. Lisa^1^ and
  Schon M. Acheson^1^ and
  Brendan M. Connors^1^
author_list: "Lacko, L.C. and Acheson, S.M. and Connors, B.M."
region: Pacific Region
isbn: ""
address: |
  ^1^Pacific Biological Station\
     Fisheries and Oceans Canada, 3190 Hammond Bay Road\
     Nanaimo, British Columbia, V9T 6N7, Canada\
phone: "(555) 555-5555"
author_footnote: "Email: Lisa.Lacko@dfo-mpo.gc.ca | telephone: (250) 756-5555"
abstract: |
  Here is the abstract text. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
abstract_other: |
  Voici le résumé. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
output:
 csasdown::techreport_pdf:
   french: false
type:
  techreport
# ------------
# End of options to set
knit: bookdown::render_book
site: bookdown::bookdown_site
link-citations: true
bibliography: bib/refs.bib
csl: csl/csas.csl
lot: true
lof: true
# Any extra LaTeX code for the header:
# header-includes:
# - \usepackage{tikz}
header-includes: \usepackage{pdflscape}
---

```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
library(knitr)
if (is_latex_output()) {
  knitr_figs_dir <- "knitr-figs-pdf/"
  knitr_cache_dir <- "knitr-cache-pdf/"
  fig_out_type <- "png"
} else {
  knitr_figs_dir <- "knitr-figs-docx/"
  knitr_cache_dir <- "knitr-cache-docx/"
  fig_out_type <- "png"
}
fig_asp <- 0.618
fig_width <- 9
fig_out_width <- "6in"
fig_dpi <- 180
fig_align <- "center"
fig_pos <- "htb"
opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = knitr_figs_dir,
  cache.path = knitr_cache_dir,
  fig.asp = fig_asp,
  fig.width = fig_width,
  out.width = fig_out_width,
  echo = FALSE,
  #  autodep = TRUE,
  #  cache = TRUE,
  cache.comments = FALSE,
  dev = fig_out_type,
  dpi = fig_dpi,
  fig.align = fig_align,
  fig.pos = fig_pos
)
options(xtable.comment = FALSE)
options(kableExtra.latex.load_packages = FALSE)
```

```{r load-libraries, cache=FALSE}
# add other packages here:
library(csasdown)
message("year = ", rmarkdown::metadata$year)
#browser()
yr  <-  2018

library(RODBC)
library(knitr)
library(magick)
library(excelR)
library(gapminder)
library(ggplot2)
library(dplyr)        # transform and summarize tabular data
library(xtable)       # produces tables
library(kableExtra)   # produces html tables with scrollbars, etc
library(pacman)       # produces numbered tables and figures in order to reference them
 #  if (!require("pacman")) install.packages("pacman")
 #  pacman::p_load(knitr, captioner, bundesligR, stringr)
library(bookdown)
library(tableHTML)

#  ----   G L O B A L --- F U N C T I O N S ---------------------------------

  GetSQLData <- function(strSQL,strDbName) {    # connect to SQL Server
            cnn <- odbcDriverConnect(paste("Driver={SQL Server};Server=DFBCV9TWVASP001;", 
                                         "Database=",
                                          strDbName,";
                                          Trusted_Connection=Yes",
                                          sep=""))
            dat <- sqlQuery(cnn, strSQL)
            odbcClose(cnn)
            return(dat) 
                                            }
  
  panLab <- function( x, y, txt, ... ) { # Allows text to be placed at 0<x<1, 0<y<1)
            usr <- par( "usr" )
            par( usr=c(0,1,0,1) )
            text( x, y, txt, ... )
            par( usr=usr )
            return( NULL )
            }
  
  cleanf <- function(x){     # function to remove duplicates
            oldx <- c(FALSE, x[-1]==x[-length(x)])  # is the value equal to the previous
            res <- x
            res[oldx] <- NA
            return(res)
            } 
  
  simpleCap <- function(x) {  # add capital first letter to each word
            s <- strsplit(x, " ")[[1]]
            paste(toupper(substring(s, 1,1)), substring(s, 2),
            sep="", 
            collapse=" ")
            }
  
  firstup <- function(x) {   # add capital first letter to first word
            substr(x, 1, 1) <- toupper(substr(x, 1, 1))
            x
            }
  
  format_cells <- function(df, rows ,cols, value = c("italics", "bold", "strikethrough")){

  # select the correct markup
  map    <- setNames(c("*", "**", "~~"), c("italics", "bold", "strikethrough"))
  markup <- map[value]  
  
  for (r in rows){
        for(c in cols){
            df[[c]] <- as.character( df[[c]])  # -- make sure values are not factors
            df[r, c] <- paste0(markup, df[r, c], markup)  # -- Update formatting
                      }
                 }
           return(df)
          }
```

```{r, echo=FALSE}
   inline_hook <- function(x) {  # -- for inline text where numbers are larger 
      if (is.numeric(x)) {
            format(x, digits = 2)
                         } else x
      }
  knitr::knit_hooks$set(inline = inline_hook)
```

```{r SurveyDetails, echo=FALSE}  
   # -- INTRODUCTION DETAILS --

   details     <- paste("select VESSEL_NAME as Vessel, CAPTAIN, ",
                        "LEFT(CONVERT(varchar, START_DATE, 100), 7) + ' - ' ",
                        "+ LEFT(CONVERT(varchar, END_DATE, 100), 7) AS [Trip Dates], ",
                        "COUNT([SET]) AS [Count of Sets] ",
                        "from  dbo.GFBIO_RESEARCH_TRIPS ",
                        "where year IN( ", yr ,",", yr+1 ,") ", 
                        "group by ",
                        "VESSEL_NAME, CAPTAIN,  ",
                        "LEFT(CONVERT(varchar, START_DATE, 100),7) + ' - ' + ",
                        "LEFT(CONVERT(varchar, END_DATE, 100),7)", 
                         sep="")
   #sd          <- GetSQLData(details,"Sablefish")  # -- survey details
   sd     <- read.csv("c:/github/surveyreport/standaloneData/details.csv",header=T)
   
   boat        <- simpleCap(tolower(sd[1,1]))      # -- vessel name 1
   boat2       <- simpleCap(tolower(sd[2,1]))      # -- vessel name 2
   
   captain     <- simpleCap(tolower(sd[1,2]))      # -- captain name 1
   captain2    <- simpleCap(tolower(sd[2,2]))      # -- captain name 2
   captain2    <- "Albert (Deacon) Melnychuk"
   
   dates       <- sd[1,3]           # -- survey start and end dates 1
   dates2      <- sd[2,3]           # -- survey start and end dates 2
   
   setcnt      <- sd[1,4]           # -- survey set count 1
   setcnt2     <- sd[2,4]           # -- survey set count 2
   
   avgC        <- paste("select ROUND(AVG(TOTAL), 0) AS YrAvg ",
                        "from   dbo.TableA2_Annual_sablefish_Landing_in_Can_waters_2 ",
                        " where (year <= ", yr+1, ") and (year >= ",yr - 8,")", sep="")
   avgTen      <- GetSQLData(avgC,"Sablefish")    # -- average catch last 10 years
   #csv avgTen <- read.csv("c:/github/surveyreport/standaloneData/avgcatch.csv",header=T)
   
   
   tp          <- paste("select ROUND(TRAP / TOTAL * 100, 0) AS TrapPer from dbo.TableA2_Annual_sablefish_Landing_in_Can_waters_2 ",  
                        " where  (year = ", yr, ")  group by ROUND(TRAP / TOTAL * 100, 0), TOTAL", sep="")
   trapP       <- GetSQLData(tp,"Sablefish")        # -- trap gear catch ratio
   #csv trapP      <- read.csv("c:/github/surveyreport/standaloneData/trapratio.csv",header=T)
   
   lp          <- paste("select  ROUND(LONGLINE / TOTAL * 100, 0) AS LonglinePer from ",  
                         " dbo.TableA2_Annual_sablefish_Landing_in_Can_waters_2  where  (year = ", yr, 
                         ") group by ROUND(LONGLINE / TOTAL * 100, 0), TOTAL", sep="")
   LonglineP   <- GetSQLData(lp,"Sablefish")        # -- longline gear catch ratio
   #csv LonglineP   <- read.csv("c:/github/surveyreport/standaloneData/llratio.csv",header=T)
   

   tp2         <- paste("select ROUND(TRAP / TOTAL * 100, 0) AS TrapPer from dbo.TableA2_Annual_sablefish_Landing_in_Can_waters_2 ",  
                        " where  (year = ", yr+1, ")  group by ROUND(TRAP / TOTAL * 100, 0), TOTAL", sep="")
   trapP2     <- GetSQLData(tp2,"Sablefish")      # -- trap gear catch ratio
   #csv trapP2      <- read.csv("c:/github/surveyreport/standaloneData/trapratio2.csv",header=T)
   
   lp2         <-  paste("select  ROUND(LONGLINE / TOTAL * 100, 0) AS LonglinePer from ",  
                         " dbo.TableA2_Annual_sablefish_Landing_in_Can_waters_2  where  (year = ", yr+1, 
                         ") group by ROUND(LONGLINE / TOTAL * 100, 0), TOTAL", sep="")
   LonglineP2 <- GetSQLData(lp2,"Sablefish")      # -- longline gear catch ratio 
   #csv LonglineP2  <- read.csv("c:/github/surveyreport/standaloneData/llratio2.csv",header=T)
   
   # -- F I G U R E   C A P T I O N S  ------------------------------------------------
   
   figure1     <- paste("Location of the boundaries of the mainland inlet localities," ,
                        "and the five spatial areas (S~1~-S~5~) of the stratified ",
                        "random survey design. The three depths strata (RD~1~-RD~3~) are colour-coded, ",
                        "nested within each of the five spatial strata.", sep="")
   
   figure2     <- paste("Start locations of survey sets (red markers) conducted in  ", yr, "(top) and ", yr+1,
                        "(bottom) for the stratified random survey areas S~1~ through S~5~.", sep="")
   
   figure3     <- paste("Location of the traditional survey sets within the mainland inlet ",
                        "localities since 1994.  The setlines for " , yr," are shown in blue and setlines for ", 
                         yr + 1," are shown in red.", sep="")
   
   figure4     <- paste("Trap gear elements consisting of 25 baited traps snapped to beckets along a groundline. ", sep="")
   
   figure5     <- paste("Distribution of yearly catch rates for Type 3 tagging sets summarised by a boxplot.  ",
                        "Each panel shows catch rates grouped by depth strata from shallow to deep (RD~1~-RD~3~) ",
                        "for each year the past 10 years of the StRS survey.  The filled circles show the mean catch rates ",
                        "for each depth stratum.", sep="")
   
   figure6     <- paste("Top: Length frequencies for male Sablefish (blue-violet) and female Sablefish ",
                        "(fuchsia) up to ", yr + 1," for all StRS sets.  The number of specimens is denoted by the ",
                        "letter n, the mean indicated by the xbar and the standard deviation is represented ",
                        "by the symbol sigma. Bottom: Average length of male and female Sablefish by year.", sep="")
   
   figure7     <-  paste("Sablefish fork length (L in cm) vs weight (W in kg) for males and females for the ",
                         yr, " and ", yr + 1 ," surveys.", sep="")
   
   figure8     <-  paste("The percentage of sub-legal Sablefish (<55 cm fork length) sampled in the StRS survey ", 
                         "strata  and depth strata  since 2003.", sep="")
   
   figure9     <-  paste("Bubble plot for male and female Sablefish ages by survey year from StRS sets that ",
                         "have been aged.  The sizes of the circles are proportional to the number of fish ", 
                         "with given ages. Fish age 35 and older are included in one bubble. The total number ", 
                         "(n) of fish aged are listed across the top of each panel. The ages with the highest ",
                         "ratios are posted to the right of each bubble.", sep="")
   
   figure10    <-  paste("Bubble plot for male Sablefish ages by survey year from offshore standardized sets, ",
                         "to the time of this report. The sizes of the circles are proportional ",
                         "to the number of fish with given ages. Fish age 35 and older are included in one bubble. ",
                         "The total number (n) of fish aged are listed across the top of each panel. The ages ",
                         "with the highest ratios are posted to the right of each bubble.", sep="")
   
   figure11    <-  paste("Coplot of average depth(m) vs average temperature (C) for a given 1-degree latitude  ",
                         "range (blue bands) for ",yr," (top) and ",yr+1," (bottom).  The number of fishing ",
                         "sets deployed with a SBE 39 recorder are represented by n.", sep="")
   
   figure12    <-  paste("Average temperatures as reported from the Sea-bird SBE 39 loggers at 1-degree ",
                         "latitude intervals and three depth intervals: 100-250 fathoms (183  to 457 meters), ",
                         "250-450 fathoms (458-823 meters) and 450-750 fathoms (824-1372 meters).", sep="") 
   
   figure_nums <-  captioner::captioner(prefix = "Figure")
   fg.ref      <-  function(x) {    # another method on how to number figures
                                     stringr::str_extract(figure_nums(x), "[^.]*")}

```

